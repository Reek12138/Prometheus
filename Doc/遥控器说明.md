## 遥控器说明

在真实飞行过程中，我们使用真实的遥控器作为控制无人机的主要操作来源，遥控器始终拥有最高的权限，精湛的遥控器操作手法可以保证无人机安稳着陆，但对于很多非专业来说，遥控的操作技巧是需要不断的练习的。我们始终强调一个观念，仿真与实机结合，这样更加符合开发流程，在以往的仿真中，我们通过键盘控制无人机飞行，并不能真实的反应出实机飞行时该怎么操作，也是基于现在存在的种种问题，为了让仿真与实机结合的更加完美，在Prometheus中增加遥控器控制方式，与真机使用更加对应起来，更加容易上手进行二次开发。下图就是仿真中的摇杆控制的框架协作图

### 遥控器仿真驱动安装

```shell
## 安装遥控器仿真驱动
sudo apt-get install jstest-gtk
## 安装完成之后，可以在终端中运行如下指令确认遥控器是否正常以及摇杆和按钮的响应情况
jstest-gtk
```

##### win下的遥控器驱动

- win系统中使用遥控器驱动软件，下载地址:

### 遥控器数据流

#### 真实飞行下的遥控器数据流（without Prometheus）

遥控器 -> 接收机  -> PX4固件（哪个模块，发布了哪个uorb消息）

#### 真实飞行下的遥控器数据流（with Prometheus）

遥控器 -> 接收机  -> PX4固件（哪个模块，发布了哪个uorb消息）-> PX4 Mavlink模块 -> Mavros（哪个文件，发布了哪个话题）  -> Prometheus订阅/mavros/rc/in话题

- PX4中哪个模块，发布了哪个uorb消息？
- PX4 - mavlink_message.cpp 发送 xxx 消息？

- Mavros - rc_io.cpp 接收RC_CHANNELS or RC_CHANNELS_RAW 消息（？），发布话题/mavros/rc/in
- uav_controller.cpp 订阅话题 /mavros/rc/in  (处理程序在rc_input.h)

#### 仿真飞行下的遥控器数据流（with Prometheus）

遥控器 -> 遥控器驱动（joy_node.cpp） -> uav_controller.cpp

- joy_node.cpp 发布话题 agent_name + "/prometheus/fake_rc_in"
- uav_controller.cpp 订阅话题 agent_name + "/prometheus/fake_rc_in" (处理程序在rc_input.h)

### 遥控器通道和方向

| 遥控器 | 通道 | 含义                                                 |
| :--: | ------  | -----------------  |
| 右摇杆（左右） | 通道1 | 滚转（向左推，无人机向左移动） |
| 右摇杆（上下） | 通道2 | 俯仰（向上推，无人机向前飞）                         |
| 左摇杆（上下） | 通道3 | 油门（向上推，无人机向上飞）                         |
| 左摇杆（左右）  | 通道4 | 偏航（向左推，无人机向左转弯）                       |
| SWA（两段开关） | 通道5 | 解锁/上锁开关                                        |
| SWB（三段开关） | 通道6 | Prometheus控制模式切换，分别对应MANUAL-HOVER-COMMAND |
| SWC（三段开关） | 通道7 | KILL开关，也可以留作用户自定义                       |
| SWD（两段开关） | 通道8 | Prometheus中的LAND模式 |

###无人机各种情况下的操作说明

	无人机档杆情况说明:
	SWA/SWC/SWD档杆都属于触发型,而SWB档杆属于维持型,SWA档杆执行解上锁操作,触发解锁操作需要从上往下拨这个动作,而不是SWA档杆处于底部,而SWB切换到某一模式,是因为档杆处于那个位置,而不是拨的动作.

### 无人机未解锁时

 1.仅能通过SWA档杆进行解锁上锁操作,SWB档杆无法切换控制模式,SWD无法切换到降落模式
 2.将SWB档杆拨到中间位置时,无人机会直接进入hover_control,而直接拨到底部位置时,无人机无法进入command_control,因为需要先进入hover_control才能切入到command_control模式

### 无人机解锁并处于manual_control(PX4处于Position模式)模式时

 1.处于地面时可执行上锁操作
 2.可使用摇杆控制无人机移动
 3.可切入hover_control模式
 4.无法切入land_control模式(需要在hover_control或land_control模式下)
 5.无法直接切入command_control模式(档杆以及软件都需要先进入hover_control模式)
 6.将SWB档杆快速切入到command_control模式时,会导致系统异常,此时,档杆处于command_control模式,但无人机上一状态为manual_control模式,导致无人机无法正常进入command_control模式

### 无人机解锁并处于hover_control(PX4处于OFFBOARD模式)模式时

 1.无人机此时会离地一定高度,不能上锁
 2.可切入land_control
 3.可切入command_control

### 无人机解锁并处于command_control(PX4处于OFFBOARD模式)模式时

 1.可切入land_control
 2.可切入hover_control
 3.将SWB档杆快速移动至顶端可直接切入到manual_control模式

### 无人机遥控器操作正常流程

 1.将SWA/SWB/SWC/SWD档杆全部打到最顶端
 2.启动相关功能代码脚本
 3.将SWA档杆切入到底端进行解锁
 4.无人机解锁后将SWB档杆切入到hover_control模式,缓慢升高到一定高度
 5.将SWB档杆切入到command_control模式,无人机进行自主飞行
 6.自主飞行任务结束后将SWD档杆拨到底端,无人机自主降落

### 无人机定位异常无法正常飞行

 1.此时无人机将触发保护机制,进行快速降落
 2.如果快速降落依然存在安全风险或无人机已经失控,则将SWC档杆向下拨,无人机电机将停转

### 无人机在commadn_control模式下需要人为接管

 1.将SWB档杆拨到中间位置或最顶端位置切换至hover_control或manual_control人为进行操作

### 无人机在land_control模式下需要人为接管(室内不支持)

 1.如果是在command_control模式下,可以将SWB档杆切换至hover_control或mamual_control模式
 2.如果是在hover_control模式下,可以将SWB档杆切换至manual_control,如果需要hover_control模式下控制,可先切换至manual_control退出land_control,再切换至hover_control



